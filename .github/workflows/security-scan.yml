name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨ 3:00 (UTC+8) è¿è¡Œ
    - cron: '0 19 * * 0'

jobs:
  slither:
    name: Slither Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install slither
      run: |
        python -m pip install --upgrade pip
        pip install slither-analyzer

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install npm dependencies
      run: |
        npm ci --only=production || npm install

    - name: Run slither scan
      run: |
        mkdir -p reports
        slither . --json reports/slither-report.json || echo "Slither found issues, but continuing..."

    - name: Generate summary
      run: |
        python3 -c "
import json
import sys

try:
    with open('reports/slither-report.json', 'r') as f:
        data = json.load(f)

    findings = data.get('results', {}).get('detectors', [])
    total = sum(len(d.get('elements', [])) for d in findings)

    print('## ðŸ”’ Slither Security Scan Results')
    print()
    print(f'Total findings: **{total}**')
    print()

    # åˆ†ç±»ç»Ÿè®¡
    high = sum(len(d.get('elements', [])) for d in findings if 'incorrect-exp' in d.get('check', ''))
    medium = sum(len(d.get('elements', [])) for d in findings if 'divide-before-multiply' in d.get('check', ''))
    low = total - high - medium

    print('| Severity | Count |')
    print('|----------|-------|')
    print(f'| ðŸ”´ High | {high} |')
    print(f'| ðŸŸ¡ Medium | {medium} |')
    print(f'| ðŸ”µ Low | {low} |')
    print()

    # æ˜¾ç¤ºå‰ 10 ä¸ª
    print('### Top Findings (First 10)')
    print()
    count = 0
    for d in findings[:10]:
        check = d.get('check', 'Unknown')
        elements = d.get('elements', [])
        for el in elements[:1]:
            print(f'**{check}**')
            if 'source_mapping' in el:
                sm = el['source_mapping']
                print(f'- File: {sm.get(\"filename\", \"unknown\")}')
                print(f'- Line: {sm.get(\"lines\", [\"unknown\"])}')
            print()
            count += 1
            if count >= 10:
                break
        if count >= 10:
            break

    if total > 10:
        print(f'... and {total - 10} more findings. See full report in artifacts.')

except Exception as e:
    print(f'Error reading report: {e}')
    print('## ðŸ”’ Slither Security Scan Results')
    print('Report generation failed.')
" > reports/summary.md

    - name: Upload slither report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: slither-report
        path: reports/slither-report.json

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          try {
            const summary = fs.readFileSync('reports/summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
          } catch (error) {
            console.error('Error reading summary:', error);
          }

  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: npm audit --production || true

    - name: Generate audit report
      run: |
        npm audit --json > reports/npm-audit.json || true
        npm audit > reports/npm-audit.txt || true

    - name: Upload audit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: npm-audit-report
        path: reports/
